# Fastfile - Fastlane automation for Thresh

default_platform(:ios)

platform :ios do

  # ==========================================
  # SCREENSHOTS
  # ==========================================

  desc "Generate App Store screenshots for all devices"
  lane :screenshots do
    capture_screenshots(
      workspace: "Thresh.xcodeproj/project.xcworkspace",
      scheme: "Thresh Life",
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true,
      concurrent_simulators: true,
      stop_after_first_error: false
    )
  end

  desc "Generate screenshots and create HTML preview"
  lane :screenshots_preview do
    capture_screenshots
    frame_screenshots(white: true)
  end

  # ==========================================
  # APP STORE UPLOAD
  # ==========================================

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    # Note: Set APP_STORE_CONNECT_ISSUER_ID environment variable or update issuer_id below
    # You can find this in App Store Connect > Users and Access > Keys
    api_key = app_store_connect_api_key(
      key_id: "VU9M7VJ4XL",
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"] || "69a6de7e-YOUR_ISSUER_ID",
      key_filepath: "/Users/drewnat/Documents/ContinuityLabsGit/secrets/AuthKey_VU9M7VJ4XL.p8",
      in_house: false
    )

    upload_to_app_store(
      api_key: api_key,
      app_identifier: "com.continuitylabs.thresh",
      skip_binary_upload: true,
      skip_metadata: true,
      skip_app_version_update: true,
      screenshots_path: "./fastlane/screenshots",
      overwrite_screenshots: true
    )
  end

  desc "Generate and upload screenshots in one step"
  lane :screenshots_and_upload do
    screenshots
    upload_screenshots
  end

  # ==========================================
  # TESTING
  # ==========================================

  desc "Run UI tests only (no screenshots)"
  lane :ui_tests do
    run_tests(
      scheme: "Thresh Life",
      only_testing: ["ThreshUITests"],
      devices: ["iPhone 16 Pro Max"]
    )
  end

  # ==========================================
  # BUILD
  # ==========================================

  desc "Build the app for testing"
  lane :build do
    build_app(
      scheme: "Thresh Life",
      skip_archive: true,
      skip_codesigning: true,
      destination: "generic/platform=iOS Simulator"
    )
  end

end
